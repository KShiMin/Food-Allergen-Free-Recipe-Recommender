<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ recipe.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .recipe-img {
      max-width: 100%;
      max-height: 350px;
      object-fit: cover;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    .card { border: none; }
    .ingredient-list li { padding-bottom: 6px; font-size: 1.05em; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4 shadow-sm">
      <div class="row g-5 align-items-start">
        <!-- Recipe image (On TOP) -->
        <div class="text-center mb-4">
          <img src="{{ recipe.img_src }}" class="recipe-img" alt="{{ recipe.name }}">
        </div>
        <div>
          <h1 class="mb-3">{{ recipe.name }}</h1>
          <p><strong>Prep:</strong> {{ recipe.prep_time }} min</p>
          <p><strong>Cook:</strong> {{ recipe.cook_time }} min</p>
          <p><strong>Servings:</strong> {{ recipe.servings }}</p>
          <p><strong>Cuisine:</strong> {{ recipe.cusine_path or recipe.cuisine_path }}</p>
          {% if recipe.video_url %}
          <p>
            <strong>Video:</strong>
            <a href="{{ recipe.video_url }}" target="_blank">{{ recipe.video_url }}</a>
          </p>
          {% endif %}

          <!-- Ingredients List -->
          <h4 class="mt-4">Ingredients</h4>
          <ul class="ingredient-list">
            {% for ing in recipe.ingredients %}
              <li>
                {{ ing.quantity }}
                {% if ing.units %}{{ ing.units }}{% endif %}
                {% if ing.ingredient_id %}{{ ing.ingredient_id }}{% endif %}
                {% if ing.preparation_notes %}
                  {% if ing.preparation_notes is string %}
                    {{ ing.preparation_notes }}
                  {% else %}
                    {% for note in ing.preparation_notes %}
                      {% if note.before %}{{ note.before }}{% endif %}
                      {% if note.after %}, {{ note.after }}{% endif %}
                    {% endfor %}
                  {% endif %}
                {% endif %}
              </li>
            {% endfor %}
          </ul>

          <!-- Allergy warning directly under ingredients -->
          {% if allergy_warning %}
            <div class="alert alert-danger border-danger my-3" style="font-weight:bold;">
              <strong>Warning!</strong> You are allergic to
              <span class="text-danger">{{ allergy_warning.allergen }}</span>.
              Please substitute with: <span class="fw-bold">{{ allergy_warning.substitute }}</span>
            </div>
          {% endif %}

          <!-- Ingredient Allergens block -->
          {% if recipe.ingredient_allergens %}
            <h5 class="mt-4 text-danger">Ingredient Allergens</h5>
            <ul>
              {% for allergen in recipe.ingredient_allergens %}
                <li>
                  {{ allergen.name }}
                  {% if allergen.description %} — {{ allergen.description }}{% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}

          <!-- Ingredient Substitutions block -->
          {% if recipe.ingredient_substitutions %}
            <h5 class="mt-4 text-warning">Substitutions</h5>
            <ul>
              {% for sub in recipe.ingredient_substitutions %}
                <li>{{ sub.ingredient }} → {{ sub.substitute }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          <!-- Directions -->
          <h4 class="mt-4">Directions</h4>
          <ol>
            {% if recipe.directions %}
              {% for step in recipe.directions.split('\n') %}
                {% if step.strip() %}
                  <li>{{ step.strip() }}</li>
                {% endif %}
              {% endfor %}
            {% elif recipe.instruction %}
              {% for step in recipe.instruction %}
                <li>{{ step.instructions }}</li>
              {% endfor %}
            {% endif %}
          </ol>

          <!-- Reviews Section -->
          <h4 class="mt-4">Reviews</h4>
          {% if session.get('user_id') %}
            <form method="post" enctype="multipart/form-data" action="{{ url_for('add_review', recipe_id=recipe._id) }}">
              <div class="mb-2">
                <textarea name="description" class="form-control" required placeholder="Write your review here..."></textarea>
              </div>
              <div class="mb-2">
                <input type="file" name="imgs" accept="image/*,video/*" multiple>
              </div>
              <div class="mb-2">
                <input type="url" name="video_url" class="form-control" placeholder="Optional: Paste video link here">
              </div>
              <button type="submit" class="btn btn-primary">Submit Review</button>
            </form>
          {% else %}
            <div class="alert alert-info">Log in to leave a review.</div>
          {% endif %}

          {% for review in reviews %}
  <div class="card my-3">
    <div class="card-body">
      <strong>{{ review.username }}</strong>
      <span class="text-muted small">{{ review.created_at.strftime('%Y-%m-%d %H:%M') if review.created_at else '' }}</span>
      <p>{{ review.description }}</p>
      {% if review.imgs %}
        {% for img in review.imgs %}
          <img src="{{ url_for('static', filename='uploads/' ~ img) }}" style="max-width:120px; max-height:120px;" class="me-2 mb-2">
        {% endfor %}
      {% endif %}
      {# Show uploaded video files #}
      {% if review.videos %}
        {% for vid in review.videos %}
          <video controls style="max-width:300px; max-height:180px;" class="me-2 mb-2">
            <source src="{{ url_for('static', filename='uploads/' ~ vid) }}">
            Your browser does not support the video tag.
          </video>
        {% endfor %}
      {% endif %}
      {# Show online video links as embedded #}
      {% if review.video_url %}
        {% set yt_id = None %}
        {% if 'youtu.be/' in review.video_url %}
          {% set yt_id = review.video_url.split('youtu.be/')[-1].split('?')[0] %}
        {% elif 'youtube.com/watch?v=' in review.video_url %}
          {% set yt_id = review.video_url.split('watch?v=')[-1].split('&')[0] %}
        {% endif %}
        {% if yt_id %}
          <div class="ratio ratio-16x9 mb-2">
            <iframe src="https://www.youtube.com/embed/{{ yt_id }}"
                    title="YouTube video"
                    allowfullscreen></iframe>
          </div>
        {% else %}
          <a href="{{ review.video_url }}" target="_blank">Video link</a>
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endfor %}


          <a href="{{ url_for('homepage') }}" class="btn btn-secondary mt-4">
            ← Back to Menu
          </a>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
